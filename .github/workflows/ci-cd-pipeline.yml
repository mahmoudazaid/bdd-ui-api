name: BDD UI-API Framework CI/CD Pipeline

# Permissions required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Ensure only one Pages deployment runs at a time
concurrency:
  group: "pages"
  cancel-in-progress: true

# Trigger pipeline on push to master branch and pull requests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

# Environment variables
env:
  MAVEN_OPTS: -Dfile.encoding=UTF-8
  JAVA_OPTS: -Xmx2g -XX:+TieredCompilation -XX:TieredStopAtLevel=1

# Jobs configuration
jobs:
  # API Tests Job
  api-tests:
    name: 🔌 API Tests
    runs-on: ubuntu-latest
    env:
      API_AUTH_TOKEN: ${{ secrets.API_AUTH_TOKEN }}
    
    steps:
      # Checkout code
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        
      # Setup Java 19
      - name: ☕ Setup Java 19
        uses: actions/setup-java@v4
        with:
          java-version: '19'
          distribution: 'temurin'
          cache: 'maven'
          
      # Cache Maven dependencies
      - name: 📦 Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      # Display versions
      - name: ℹ️ Display versions
        run: |
          echo "🔍 Environment Information:"
          echo "=========================="
          echo "Java version:"
          java -version
          echo ""
          echo "Maven version:"
          mvn -version
          echo ""
          echo "Current directory:"
          pwd
          
      # Compile project
      - name: 🔨 Compile project
        run: mvn clean compile test-compile -q
        
      # Run API tests
      - name: 🧪 Run API tests
        run: mvn clean test -Dtest=APICucumberRunner -Dapi.auth.token=${API_AUTH_TOKEN} -q
        
      # Upload API test results
      - name: 📤 Upload API test results
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: |
            target/cucumber-reports/
            target/surefire-reports/
          retention-days: 30
          
      # Upload API HTML report
      - name: 📊 Upload API HTML report
        uses: actions/upload-artifact@v4
        with:
          name: api-html-report
          path: target/cucumber-reports/api-cucumber.html
          retention-days: 30

  # UI Tests Job
  ui-tests:
    name: 🖥️ UI Tests
    runs-on: ubuntu-latest
    env:
      API_AUTH_TOKEN: ${{ secrets.API_AUTH_TOKEN }}
    
    steps:
      # Checkout code
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        
      # Setup Java 19
      - name: ☕ Setup Java 19
        uses: actions/setup-java@v4
        with:
          java-version: '19'
          distribution: 'temurin'
          cache: 'maven'
          
      # Cache Maven dependencies
      - name: 📦 Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      # Display versions
      - name: ℹ️ Display versions
        run: |
          echo "🔍 Environment Information:"
          echo "=========================="
          echo "Java version:"
          java -version
          echo ""
          echo "Maven version:"
          mvn -version
          echo ""
          echo "Current directory:"
          pwd
          
      # Compile project
      - name: 🔨 Compile project
        run: mvn clean compile test-compile -q
        
      # Run UI tests
      - name: 🧪 Run UI tests
        run: mvn clean test -Dtest=UICucumberRunner -q

      # Upload Cucumber HTML (UI)
        
      # Upload UI test results
      - name: 📤 Upload UI test results
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: |
            target/cucumber-reports/
            target/surefire-reports/
          retention-days: 30
          
      # Upload UI HTML report
      - name: 📊 Upload UI HTML report
        uses: actions/upload-artifact@v4
        with:
          name: ui-html-report
          path: target/cucumber-reports/ui-cucumber.html
          retention-days: 30

  

  # Deploy combined Masterthought report to GitHub Pages
  deploy-pages:
    name: 🚀 Deploy Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests]
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup Java 19
        uses: actions/setup-java@v4
        with:
          java-version: '19'
          distribution: 'temurin'
          cache: 'maven'

      - name: 🔨 Build and generate combined report (UI + API)
        run: mvn -P dev -Dmaven.test.failure.ignore=true -q clean test verify

      - name: 🪄 Ensure index.html exists for GitHub Pages
        run: |
          REPORT_DIR=target/reports/cucumber-html-reports
          if [ -d "$REPORT_DIR" ]; then
            ls -la "$REPORT_DIR"
            if [ -f "$REPORT_DIR/overview-features.html" ]; then
              cp "$REPORT_DIR/overview-features.html" "$REPORT_DIR/index.html"
            fi
          fi

      - name: ⚙️ Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: 📦 Upload Pages artifact (Masterthought report)
        uses: actions/upload-pages-artifact@v3
        with:
          path: target/reports/cucumber-html-reports

      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4